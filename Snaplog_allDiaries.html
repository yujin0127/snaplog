<!DOCTYPE html>
<html data-theme="light" lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ìŠ¤ëƒ…ë¡œê·¸ | ì „ì²´ ì¼ê¸° ëª©ë¡</title>
  <link rel="stylesheet" href="./snaplog.css">
  <style>
    .layout { display:grid; grid-template-columns: 300px 1fr; gap:16px; padding:16px; }
    .list-area { display:flex; flex-direction:column; gap:12px; }
    .filter-bar { display:flex; gap:8px; align-items:center; }
    .filter-bar select, .filter-bar input[type="text"]{
      padding:10px; border-radius:10px; border:1px solid var(--line-strong); background:var(--card);
      outline:none; min-width:80px;
    }
    .filter-bar .btn { height:48px; padding:10px 14px; border-radius:12px; }
    .results { display:flex; flex-direction:column; gap:10px; max-height:56vh; overflow:auto; padding-right:6px; }
    .diary-row { display:flex; align-items:center; justify-content:space-between; gap:12px; padding:12px; border-radius:12px; border:1px solid var(--line); background: var(--theme-bg, #fff); }
    .diary-left { display:flex; gap:12px; align-items:center; }
    .thumb-sm { width:64px; height:64px; object-fit:cover; border-radius:10px; border:1px solid var(--line); background:#eee; }
    .meta { display:flex; flex-direction:column; min-width:0; }
    .meta .title { font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .meta .date { font-size:12px; color:var(--muted); margin-top:4px; }
    .meta .excerpt { font-size:13px; color:var(--muted); margin-top:6px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width: 400px; }
    .card-footer { margin-top:12px; display:flex; flex-direction:column; gap:8px; }
    .pager { display:flex; gap:8px; align-items:center; justify-content:center; }
    .pager .btn { padding:8px 12px; height:40px; border-radius:10px; }
    .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.25); align-items:center; justify-content:center; padding:20px; z-index:60; }
    .modal .card { width:min(900px, 96vw); max-height:80vh; overflow:auto; }
    @media (max-width:900px){ .layout{ grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="bg">
    <div class="panel" id="appPanel" style="display:block;">
      <div class="topbar">
        <div class="brand">ìŠ¤ëƒ…ë¡œê·¸</div>
        <span class="badge" id="statAll">ì „ì²´ 0</span>
        <span class="badge" id="statMonth">ì´ë²ˆ ë‹¬ 0</span>
        <span class="badge" id="statPhotos">ì‚¬ì§„ 0</span>
        <div class="spacer"></div>
        <div class="toggle" title="ë‹¤í¬ëª¨ë“œ">
          <span aria-hidden="true" class="label">ë‹¤í¬ëª¨ë“œ</span>
          <label class="switch">
            <input id="darkToggleApp" type="checkbox"/>
            <span class="slider"></span>
          </label>
        </div>
        <a class="btn ghost" href="./index.html" 
        style="margin-left:12px; text-decoration: none;">ì‘ì„±í•˜ëŸ¬ ê°€ê¸°</a>
      </div>

      <div class="layout" id="layout">
        <aside class="card" style="padding-bottom:12px;">
          <div class="section-title">ë‹¬ë ¥</div>
          <div class="row small" style="margin-bottom:6px; display:flex; gap:6px; align-items:center;">
            <button class="btn ghost" id="prevM">â—€ï¸</button>
            <div id="ym"></div>
            <button class="btn ghost" id="nextM">â–¶ï¸</button>
          </div>
          <div class="calendar" id="calendar"></div>

          <hr style="opacity:.6; margin:12px 0"/>
          <div class="section-title">ìµœê·¼ ê¸°ë¡</div>
          <div class="list small" id="recent"></div>
        </aside>

        <section class="card" style="display:flex; flex-direction:column;">
          <div style="display:flex; align-items:center; justify-content:space-between;">
            <div class="section-title">ì „ì²´ ì¼ê¸° ëª©ë¡</div>
            <div style="display:flex; gap:6px; align-items:center;">
              <select id="filterYear" style="height:40px; border-radius:10px; padding:8px;"></select>
              <select id="filterMonth" style="height:40px; border-radius:10px; padding:8px;"></select>
              <input id="searchInput" type="text" placeholder="ì œëª©/ë‚´ìš© ê²€ìƒ‰" style="height:40px; border-radius:10px; padding:8px;" />
              <button id="resetBtn" class="btn ghost">ì´ˆê¸°í™”</button>
            </div>
          </div>

          <div style="margin-top:12px; flex:1; display:flex; flex-direction:column;">
            <div class="results" id="results" style="flex:1; overflow:auto;"></div>
            <div class="card-footer">
              <div class="pager" id="pager">
                <button id="prevPage" class="btn ghost">ì´ì „</button>
                <div id="pageInfo" class="small" style="align-self:center;"></div>
                <button id="nextPage" class="btn ghost">ë‹¤ìŒ</button>
              </div>
              <div class="tabs">
                <a href="./index.html" 
                class="tab" data-tab="diary" style="text-decoration: none;">ì¼ê¸°</a>
                <a href="./SnaplogMap.html" 
                class="tab" data-tab="map" style="text-decoration: none;">ì§€ë„</a>
                <div class="tab active">ì „ì²´ì¼ê¸°</div>
               </div>
            </div>
          </div>
        </section>
      </div>
    </div>
  </div>

  <div id="modal" class="modal">
    <div class="card">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 14px;border-bottom:1px solid var(--line);">
        <div>
          <strong id="m-title">ì œëª©</strong>
          <div class="small" id="m-date"></div>
        </div>
        <div style="display:flex;gap:8px;align-items:center;">
          <button id="closeModal" class="btn ghost">ë‹«ê¸°</button>
        </div>
      </div>
      <div style="padding:14px;">
        <div id="m-body" style="white-space:pre-wrap;line-height:1.6;"></div>
        <div id="m-gallery" class="gallery" style="margin-top:12px;"></div>
      </div>
    </div>
  </div>

<script>
(function(){
  "use strict";

  function saveLS(k,v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch(e){ console.warn("save fail",k,e); } }
  function loadLS(k,f){ try{ const v=localStorage.getItem(k); return v? JSON.parse(v): f; }catch(e){ return f; } }
  function parseYMD(s){ const [y,m,d] = (s||"").split("-").map(x=>parseInt(x,10)); return {y,m,d}; }

  // ================== IndexedDB helper ==================
  function openDB(){
    return new Promise((resolve,reject)=>{
      const r = indexedDB.open('snaplog-db',1);
      r.onupgradeneeded = ()=>{ 
        const db = r.result; 
        if(!db.objectStoreNames.contains('entries')) 
          db.createObjectStore('entries',{keyPath:'id'});
      };
      r.onsuccess = ()=>resolve(r.result);
      r.onerror = ()=>reject(r.error);
    });
  }

  async function getAllFromIDB(){
    const db = await openDB();
    return new Promise((resolve,reject)=>{
      const tx = db.transaction('entries','readonly');
      const req = tx.objectStore('entries').getAll();
      req.onsuccess = ()=>{ resolve(req.result); db.close(); };
      req.onerror = ()=>{ reject(req.error); db.close(); };
    });
  }

  async function deleteEntryFromIDB(id){
    const db = await openDB();
    return new Promise((resolve,reject)=>{
      const tx = db.transaction('entries','readwrite');
      tx.objectStore('entries').delete(id);
      tx.oncomplete = ()=>{ resolve(true); db.close(); };
      tx.onerror = ()=>{ reject(tx.error); db.close(); };
    });
  }

  const state = {
    entries: [],
    theme: loadLS('theme','light'),
    cal: new Date(),
    filtered: [],
    page: 1,
    perPage: 15,
    activeKeyword: ''
  };

  function applyTheme(t){ document.documentElement.setAttribute('data-theme', t); saveLS('theme', t); }
  applyTheme(state.theme);

  const darkToggleApp = document.getElementById('darkToggleApp');
  if(darkToggleApp){
    darkToggleApp.checked = state.theme==='dark';
    darkToggleApp.addEventListener('change', ()=>{ state.theme = darkToggleApp.checked?'dark':'light'; applyTheme(state.theme); });
  }

  function $(s,p=document){ return p.querySelector(s); }

  function renderStats(){
    const all = state.entries.length;
    const monthKey = (new Date().getFullYear()) + "-" + String(new Date().getMonth()+1).padStart(2,'0');
    const month = state.entries.filter(e=> (e.date||"").startsWith(monthKey)).length;
    const photos = state.entries.filter(e=> Array.isArray(e.photos) ? e.photos.length : (e.photo?1:0)).length;
    $('#statAll').textContent = `ì „ì²´ ${all}`;
    $('#statMonth').textContent = `ì´ë²ˆ ë‹¬ ${month}`;
    $('#statPhotos').textContent = `ì‚¬ì§„ ${photos}`;
  }

  function renderCalendar(){
    const cal = $('#calendar'); if(!cal) return;
    cal.innerHTML='';
    const ym = $('#ym');
    const cur = new Date(state.cal.getFullYear(), state.cal.getMonth(), 1);
    ym.textContent = `${cur.getFullYear()}ë…„ ${String(cur.getMonth()+1).padStart(2,'0')}ì›”`;

    const daysHeader = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
    daysHeader.forEach(d=>{ const h=document.createElement('div'); h.className='cell head'; h.textContent=d; cal.appendChild(h); });

    const firstDay = new Date(cur.getFullYear(), cur.getMonth(), 1).getDay();
    const lastDate = new Date(cur.getFullYear(), cur.getMonth()+1, 0).getDate();
    for(let i=0;i<firstDay;i++){ const e=document.createElement('div'); e.className='cell head'; e.style.visibility='hidden'; cal.appendChild(e); }

    const saved = new Set(state.entries.filter(e=>{ if(!e.date) return false; const {y,m} = parseYMD(e.date); return y===cur.getFullYear() && m===cur.getMonth()+1; }).map(e=> parseYMD(e.date).d));

    const today=new Date();
    for(let d=1; d<=lastDate; d++){
      const cell=document.createElement('div'); cell.className='cell'; cell.textContent = d;
      if(saved.has(d)) cell.classList.add('saved');
      if(d===today.getDate() && cur.getMonth()===today.getMonth() && cur.getFullYear()===today.getFullYear()) cell.classList.add('today');
      cell.onclick=()=>{
        state.cal = new Date(cur.getFullYear(), cur.getMonth(), d);
        $('#filterYear').value = cur.getFullYear();
        $('#filterMonth').value = cur.getMonth()+1;
        state.page=1;
        applyFiltersAndRender();
      };
      cal.appendChild(cell);
    }
  }

  function renderRecent(){
    const box = $('#recent'); if(!box) return;
    box.innerHTML='';
    const arr = state.entries.slice().sort((a,b)=>(b.tn||0)-(a.tn||0)).slice(0,50);
    if(arr.length===0){ box.innerHTML = '<div class="small">ìµœê·¼ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
    arr.forEach(e=>{
      const it=document.createElement('div'); it.className='item';
      const left=document.createElement('div'); left.innerHTML = `<div><strong>${e.title || 'ì œëª© ì—†ìŒ'}</strong></div><div class="small">${e.date || ''}</div>`;
      const right=document.createElement('button'); right.className='btn ghost'; right.textContent='ë³´ê¸°';
      right.onclick=()=>{ openModal(e); };
      it.append(left,right); box.appendChild(it);
    });
  }

  function openModal(e){
    const m = $('#modal'); if(!m) return; m.style.display='flex';
    $('#m-title').textContent = e.title || 'ì œëª© ì—†ìŒ';
    $('#m-date').textContent = e.date || '';
    $('#m-body').textContent = e.body || e.text || '';
    const gallery = $('#m-gallery'); gallery.innerHTML='';
    const photos = Array.isArray(e.photos) ? e.photos : (e.photo ? [e.photo] : []);
    photos.forEach(src=>{
      const d = document.createElement('div'); d.style.flex='0 0 auto'; d.style.width='140px'; d.style.height='140px'; d.style.borderRadius='10px'; d.style.overflow='hidden'; d.style.border='1px solid var(--line)'; d.style.marginRight='8px';
      const im = document.createElement('img'); im.src = src; im.style.width='100%'; im.style.height='100%'; im.style.objectFit='cover';
      d.appendChild(im); gallery.appendChild(d);
    });
  }
  $('#closeModal')?.addEventListener('click', ()=>{ $('#modal').style.display='none'; });

  function excerpt(s, n=180){ if(!s) return ''; return s.length>n? s.slice(0,n-1)+'â€¦': s; }

  function renderResults(){
    const container = $('#results'); if(!container) return;
    container.innerHTML = '';
    const total = state.filtered.length;
    const totalPages = Math.max(1, Math.ceil(total / state.perPage));
    if(state.page > totalPages) state.page = totalPages;

    const start = (state.page - 1) * state.perPage;
    const end = start + state.perPage;
    const pageItems = state.filtered.slice(start, end);

    if(pageItems.length === 0){
      container.innerHTML = `<div style="text-align:center; color:var(--muted); padding:18px;">í‘œì‹œí•  ì¼ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
    } else {
      pageItems.forEach(e=>{
        const row = document.createElement('div'); row.className = 'diary-row';
        const left = document.createElement('div'); left.className='diary-left';
        const img = document.createElement('img'); img.className='thumb-sm';
        const thumb = (e.photos && e.photos.length) ? e.photos[0] : (e.photo || '');
        if(thumb) img.src = thumb; else img.style.display='none';
        const meta = document.createElement('div'); meta.className='meta';
        const t = document.createElement('div'); t.className='title'; t.textContent = e.title || 'ì œëª© ì—†ìŒ';
        const d = document.createElement('div'); d.className='date'; d.textContent = e.date || '';
        const ex = document.createElement('div'); ex.className='excerpt'; ex.textContent = excerpt(e.body || e.text || '');
        meta.appendChild(t); meta.appendChild(d); meta.appendChild(ex);

        left.appendChild(img); left.appendChild(meta);

        const right = document.createElement('div');
        const openBtn = document.createElement('button'); openBtn.className='btn ghost'; openBtn.textContent='ì—´ê¸°';
        openBtn.onclick = ()=> openModal(e);
        right.appendChild(openBtn);

        row.appendChild(left); row.appendChild(right);
        container.appendChild(row);
      });
    }

    $('#pageInfo').textContent = `${state.page} / ${totalPages}`;
    $('#prevPage').disabled = state.page <= 1;
    $('#nextPage').disabled = state.page >= totalPages;
  }

  // function initYearMonthFilters(){
  //   const yearSel = $('#filterYear');
  //   const monthSel = $('#filterMonth');
  //   const thisYear = new Date().getFullYear();
  //   for(let y=2021; y<=thisYear; y++){ const opt = document.createElement('option'); opt.value=y; opt.textContent=y+'ë…„'; yearSel.appendChild(opt);}
  //   for(let m=1; m<=12; m++){ const opt = document.createElement('option'); opt.value=m; opt.textContent=m+'ì›”'; monthSel.appendChild(opt);}
  //   yearSel.value=thisYear;
  //   monthSel.value=new Date().getMonth()+1;
  // }
  // initYearMonthFilters();

  function initYearMonthFilters(){
  const yearSel = $('#filterYear');
  const monthSel = $('#filterMonth');
  const thisYear = new Date().getFullYear();
  const thisMonth = new Date().getMonth()+1;
  
  // ì „ì²´ ì˜µì…˜ ì¶”ê°€
  const allYearOpt = document.createElement('option');
  allYearOpt.value = '';
  allYearOpt.textContent = 'ì „ì²´';
  yearSel.appendChild(allYearOpt);
  
  for(let y=2021; y<=thisYear; y++){ 
    const opt = document.createElement('option'); 
    opt.value=y; 
    opt.textContent=y+'ë…„'; 
    yearSel.appendChild(opt);
  }
  
  // ì „ì²´ ì˜µì…˜ ì¶”ê°€
  const allMonthOpt = document.createElement('option');
  allMonthOpt.value = '';
  allMonthOpt.textContent = 'ì „ì²´';
  monthSel.appendChild(allMonthOpt);
  
  for(let m=1; m<=12; m++){ 
    const opt = document.createElement('option'); 
    opt.value=m; 
    opt.textContent=m+'ì›”'; 
    monthSel.appendChild(opt);
  }
  
  // ì˜µì…˜ ìƒì„± í›„ ê°’ ì„¤ì •
  yearSel.value = String(thisYear);
  monthSel.value = String(thisMonth);
}
  initYearMonthFilters();
  
  function applyFiltersAndRender(){
    const year = $('#filterYear').value;
    const month = $('#filterMonth').value;
    const keyword = (state.activeKeyword || '').toLowerCase().trim();

    state.filtered = state.entries.filter(e=>{
  if(!e.date) return false;
  const {y,m} = parseYMD(e.date);
  const matchYM = (!year || year==='' || y==year) && (!month || month==='' || m==month);
  const hay = ((e.title||'')+' '+(e.body||e.text||'')).toLowerCase();
  const matchKeyword = !keyword || hay.includes(keyword);
  return matchYM && matchKeyword;
});

    state.filtered.sort((a,b)=> (b.ts || 0) - (a.ts || 0));
    renderResults();
    renderStats();
    renderRecent();
    renderCalendar();
  }

  $('#filterYear').addEventListener('change', ()=>{ state.page=1; applyFiltersAndRender(); });
  $('#filterMonth').addEventListener('change', ()=>{ state.page=1; applyFiltersAndRender(); });
  $('#searchInput').addEventListener('input', (ev)=>{ state.activeKeyword = ev.target.value || ''; state.page=1; applyFiltersAndRender(); });
  $('#resetBtn').addEventListener('click', ()=>{
    $('#filterYear').value = new Date().getFullYear();
    $('#filterMonth').value = new Date().getMonth()+1;
    $('#searchInput').value='';
    state.activeKeyword='';
    state.page=1;
    applyFiltersAndRender();
  });

  $('#prevPage').addEventListener('click', ()=>{ if(state.page>1){ state.page--; renderResults(); } });
  $('#nextPage').addEventListener('click', ()=>{ const totalPages = Math.max(1, Math.ceil(state.filtered.length/state.perPage)); if(state.page<totalPages){ state.page++; renderResults(); } });

  $('#prevM').addEventListener('click', ()=>{ state.cal = new Date(state.cal.getFullYear(), state.cal.getMonth()-1,1); renderCalendar(); });
  $('#nextM').addEventListener('click', ()=>{ state.cal = new Date(state.cal.getFullYear(), state.cal.getMonth()+1,1); renderCalendar(); });

  // âœ… IndexedDBì—ì„œ ë°ì´í„° ë¡œë“œ
  async function loadEntries(){
    try{
      state.entries = await getAllFromIDB();
      state.entries = state.entries.map(e=>{
        if(e && e.date){
          const {y,m,d} = parseYMD(e.date);
          if(y && m && d) e.date = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        }
        return e;
      });
      state.filtered = state.entries.slice().sort((a,b)=> (b.ts||0)-(a.ts||0));
      state.page=1;
      applyFiltersAndRender();
      console.log('âœ… IndexedDBì—ì„œ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', state.entries.length, 'ê°œ');
    }catch(e){
      console.error('âŒ IndexedDB ë¡œë“œ ì‹¤íŒ¨:', e);
      alert('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
  }

  // âœ… ë‹¤ë¥¸ íƒ­ì—ì„œ ì €ì¥ ì´ë²¤íŠ¸ ê°ì§€
  window.addEventListener('entrySaved', ()=>{
    console.log('ğŸ”„ ë‹¤ë¥¸ íƒ­ì—ì„œ ì €ì¥ë¨ - ìƒˆë¡œê³ ì¹¨');
    loadEntries();
  });

  // âœ… ì´ˆê¸° ë¡œë“œ
  loadEntries();

})();
</script>
</body>
</html>
