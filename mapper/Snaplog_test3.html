<!DOCTYPE html>
<html data-theme="light" lang="ko">
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <title>ìŠ¤ëƒ…ë¡œê·¸ | Snaplog</title>
  <link rel="stylesheet" href="mainpage.css">
 </head>
 <body>
  <div class="bg">
   <!-- Intro -->
   <div class="panel" id="intro">
    <div class="intro" style="display:flex; flex-direction:column; align-items:center; justify-content:center;">
     <div class="hero">ìŠ¤ëƒ…ë¡œê·¸</div>
     <div class="sub">ì‚¬ì§„ìœ¼ë¡œ ë‚¨ê¸°ëŠ” ì˜¤ëŠ˜ì˜ ìˆœê°„</div>
     <div class="cta">
      <button class="btn" id="startBtn">ì‹œì‘í•˜ê¸°</button>
     </div>
    </div>
   </div>
   <!-- App -->
   <div class="panel" id="app" style="display:none">
    <div class="topbar">
     <div class="brand">ìŠ¤ëƒ…ë¡œê·¸</div>
     <span class="badge" id="statAll">ì „ì²´ 0</span>
     <span class="badge" id="statMonth">ì´ë²ˆ ë‹¬ 0</span>
     <span class="badge" id="statPhotos">ì‚¬ì§„ 0</span>
     <div class="spacer"></div>
     <div class="toggle" title="ë‹¤í¬ëª¨ë“œ">
      <span aria-hidden="true" class="label">ë‹¤í¬ëª¨ë“œ</span>
      <label class="switch">
       <input id="darkToggleApp" type="checkbox"/>
       <span class="slider"></span>
      </label>
     </div>
    </div>
    <div class="layout" id="layout" style="display:grid">
     <aside class="card">
      <div class="section-title">ë‹¬ë ¥</div>
      <div class="row small" style="margin-bottom:6px; display:flex; gap:6px; align-items:center;">
       <button class="btn ghost" id="prevM">â—€ï¸</button>
       <div id="ym"></div>
       <button class="btn ghost" id="nextM">â–¶ï¸</button>
      </div>
      <div class="calendar" id="calendar"></div>
      <hr style="opacity:.6; margin:12px 0"/>
      <div class="section-title">ìµœê·¼ ê¸°ë¡</div>
      <div class="list small" id="recent"></div>
     </aside>
     <section class="card">
      <div class="section-title">ì˜¤ëŠ˜ì˜ ê¸°ë¡</div>
      <div class="tools">
       <label class="btn input-file daily_button">
        ì‚¬ì§„ ì—…ë¡œë“œ
        <input accept="image/*" id="file" multiple type="file"/>
       </label>
       <button class="btn daily_button" id="autoBtn">ìë™ ìƒì„±</button>
       <button class="btn daily_button" id="saveBtn">ì €ì¥</button>
       <button class="btn ghost daily_button" id="delBtn">ì‚­ì œ</button>
      </div>
      <div style="margin-top:10px; position:relative">
       <div class="preview-wrap" id="previewWrap">
        <span class="ph">ë¯¸ë¦¬ë³´ê¸°</span>
        <img alt="ë¯¸ë¦¬ë³´ê¸°" class="preview" id="preview"/>
        <button class="nav-arrow" id="navPrev">â€¹</button>
        <button class="nav-arrow" id="navNext">â€º</button>
       </div>
       <div class="gallery" id="galleryBar">
        <div class="camera-tile" id="cameraTile">
         <div class="cam-icon">ğŸ“·</div>
         <div class="cam-count"><span id="camCount">0</span>/10</div>
        </div>
        <div class="thumbs" id="thumbs"></div>
       </div>
      </div>
      <div class="editor">
       <input class="titlebox" id="title" maxlength="20" placeholder="ì œëª©(ìµœëŒ€ 20ì)" type="text"/>
      </div>
      <div class="editor">
       <textarea class="textbox" id="text" placeholder="ìë™ìœ¼ë¡œ ìƒì„±ë˜ê±°ë‚˜ ì§ì ‘ ì ì„ ìˆ˜ ìˆìŒ"></textarea>
      </div>
      <div class="tabs">
       <div class="tab active">ì¼ê¸°</div>
       <div class="tab">ì§€ë„</div>
       <div class="tab">ì „ì²´ì¼ê¸°</div>
      </div>
     </section>
    </div>
   </div>
  </div>
<script>
(function(){
  "use strict";

  // ================== ì„¤ì • ==================
  const API_URL = "http://127.0.0.1:5000/api/auto-diary";
  const FOOD_HINTS = ['food','meal','lunch','dinner','breakfast','cafe','coffee','cake','bread','noodle','ramen','pizza','burger','pasta','sushi','ì‹ë‹¹','ë°¥','ì ì‹¬','ì €ë…','ì•„ì¹¨','ì¹´í˜','ì»¤í”¼','ì¼€ì´í¬','ë¹µ','ë¼ë©´','í”¼ì','ë²„ê±°','íŒŒìŠ¤íƒ€','ìŠ¤ì‹œ'];
  const MAX_UPLOAD = 10;

  // ================== ìœ í‹¸ ==================
  const $ = (s,p=document)=>p.querySelector(s);
  const $$ = (s,p=document)=>Array.from(p.querySelectorAll(s));
  function saveLS(k,v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch(e){ console.warn("save fail",k,e); } }
  function loadLS(k,f){ try{ const v=localStorage.getItem(k); return v? JSON.parse(v): f; }catch(e){ return f; } }
  function newId(){ return Math.random().toString(36).slice(2)+Date.now().toString(36); }
  function getMonthKey(d){ return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,'0'); }
  function parseYMD(s){ const [y,m,d] = (s||"").split("-").map(x=>parseInt(x,10)); return {y,m,d}; }

  // ì´ë¯¸ì§€ ì¶•ì†Œ(JPEG) â†’ dataURL
  async function downscaleToDataURL(file, maxSide=1280, quality=0.8){
    const img = await new Promise((res,rej)=>{
      const fr = new FileReader();
      fr.onload = ()=>{ const i = new Image(); i.onload=()=>res(i); i.onerror=rej; i.src = fr.result; };
      fr.onerror = rej; fr.readAsDataURL(file);
    });
    const w = img.naturalWidth, h = img.naturalHeight;
    const ratio = w > h ? maxSide / w : maxSide / h;
    const nw = ratio < 1 ? Math.round(w*ratio) : w;
    const nh = ratio < 1 ? Math.round(h*ratio) : h;
    const canvas = document.createElement('canvas');
    canvas.width = nw; canvas.height = nh;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(img, 0, 0, nw, nh);
    return canvas.toDataURL('image/jpeg', quality);
  }

  // ================== ìƒíƒœ ==================
  const state = {
    entries: loadLS('entries', []),
    theme: loadLS('theme','light'),
    cursor:null,
    cal:new Date(),
    tempPhotos:[],
    tempNames:[],
    repIndex:0,
    viewIndex:0,
    tone:'ì¤‘ë¦½'
  };

  // ================== ë¶„ë¥˜/ë¼ë²¨ ==================
  function classifyCategory(fileNames){
    if(!fileNames || !fileNames.length) return 'general_single';
    if(fileNames.length === 1){
      const n = (fileNames[0]||'').toLowerCase();
      const isFood = FOOD_HINTS.some(k=> n.includes(k));
      return isFood ? 'food_single' : 'general_single';
    }
    return 'journey_multi';
  }

  function normalizeTimeLabel(idx, total){
    if(total<=1) return 'ì˜¤í›„';
    const ratio = idx/(total-1);
    if(ratio < 0.25) return 'ì˜¤ì „';
    if(ratio < 0.5) return 'ì •ì˜¤';
    if(ratio < 0.75) return 'ì˜¤í›„';
    return 'ì €ë…';
  }

  // ================== Summary ==================
  function buildPhotosSummary(state){
    const total = state.tempPhotos.length;
    const now = new Date();
    const ymd = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
    const arr = [];
    for(let i=0;i<total;i++){
      arr.push({ place:'', time:`${ymd} ${normalizeTimeLabel(i,total)}`, weather:'', desc:'' });
    }
    return arr;
  }

  // ================== API ==================
  async function callAutoDiaryAPI(images, photosSummary, tone){
    if(!API_URL) return null;
    const ctrl = new AbortController();
    const t = setTimeout(()=>ctrl.abort('timeout'), 45000);
    try{
      const r = await fetch(API_URL, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ tone, images, photosSummary }),
        signal: ctrl.signal
      });
      clearTimeout(t);
      const text = await r.text();
      let data = null;
      try{ data = JSON.parse(text); }catch{}
      if(!r.ok){
        const msg = data?.error || data?.message || (`HTTP ${r.status}: `+text.slice(0,200));
        alert('ìë™ìƒì„± ì‹¤íŒ¨: '+msg);
        return null;
      }
      if(data && data.ok) return data;
      alert('ìë™ìƒì„± ì‹¤íŒ¨: '+(data?.error || 'unknown'));
      return null;
    }catch(e){
      clearTimeout(t);
      alert('ìë™ìƒì„± ì„œë²„ ì‘ë‹µì´ ì—†ìŠµë‹ˆë‹¤: '+e);
      return null;
    }
  }

  // ================== Fallback ==================
  function fallbackGenerate(photosSummary, cat){
    const n = photosSummary.length;
    const s = x => x || '';
    if(cat === 'journey_multi' && n>=2){
      const a = photosSummary;
      const t0 = s(a[0].time).split(' ').pop();
      const first = s(a[0].place) ? `${s(a[0].place)}ì—ì„œ ${t0}ì— í•˜ë£¨ë¥¼ ì—´ì—ˆë‹¤.` : `${t0}ì— í•˜ë£¨ë¥¼ ì—´ì—ˆë‹¤.`;
      const parts = [first];
      for(let i=1;i<n-1;i++){
        const seg = [];
        if (s(a[i].place)) seg.push(`${s(a[i].place)}ë¡œ ì˜®ê¸°ë©°`);
        if (s(a[i].desc))  seg.push(`${s(a[i].desc)}ì„ ì§€ë‚˜ì³¤ë‹¤`);
        parts.push(seg.length ? seg.join(' ') + '.' : 'ì ì‹œ ê±¸ìŒì„ ëŠ¦ì·„ë‹¤.');
      }
      parts.push(`${s(a[n-1].place) || 'ì£¼ë³€'}ì˜ ë¹›ì´ ì²œì²œíˆ ë°”ë€Œì—ˆë‹¤.`);
      parts.push('ë‚¨ì€ ì†Œë¦¬ì™€ ì˜¨ê¸°ê°€ ì¡°ìš©íˆ ì •ë¦¬ë˜ì—ˆë‹¤.');
      return parts.slice(0,7).join("\\n");
    } else {
      const p = photosSummary[0] || {place:'', time:'ì˜¤í›„', weather:'', desc:''};
      const tpart = s(p.time).split(' ').pop();
      const first = s(p.place) ? `${s(p.place)}ì—ì„œ ${tpart}ì— ì ì‹œ ë©ˆì·„ë‹¤.` : `${tpart}ì— ì ì‹œ ë©ˆì·„ë‹¤.`;
      const parts = [first];
      if (s(p.desc)) parts.push(`${s(p.desc)}ì´ ëˆˆì— ë“¤ì–´ì™”ë‹¤.`);
      parts.push('ìˆ¨ì„ ê³ ë¥´ë‹ˆ ê³µê°„ì˜ ê²°ì´ ë˜ë ·í•´ì¡Œë‹¤.');
      parts.push('ì§§ì€ ê³ ìš”ê°€ ì˜¤ëŠ˜ì˜ ëì„ ë¶€ë“œëŸ½ê²Œ ë®ì—ˆë‹¤.');
      return parts.slice(0,4).join("\\n");
    }
  }

  // ================== í…Œë§ˆ ==================
  function applyTheme(t){ document.documentElement.setAttribute('data-theme', t); saveLS('theme', t); }

  // ================== ë Œë”ëŸ¬ ==================
  function renderStats(){
    try{
      const all = state.entries.length;
      const monthKey = getMonthKey(new Date());
      const month = state.entries.filter(e=> (e.date||"").startsWith(monthKey)).length;
      const photos = state.entries.filter(e=> Array.isArray(e.photos) ? e.photos.length : (e.photo?1:0)).length;
      const a=$('#statAll'), m=$('#statMonth'), p=$('#statPhotos');
      if(a) a.textContent = `ì „ì²´ ${all}`;
      if(m) m.textContent = `ì´ë²ˆ ë‹¬ ${month}`;
      if(p) p.textContent = `ì‚¬ì§„ ${photos}`;
    }catch(e){ console.warn('renderStats error', e); }
  }

  function renderRecent(){
    try{
      const box = $('#recent'); if(!box) return;
      box.innerHTML='';
      state.entries.slice().reverse().slice(0,50).forEach(e=>{
        const it=document.createElement('div'); it.className='item';
        const left=document.createElement('div');
        left.innerHTML = `<div><strong>${e.title || 'ì œëª© ì—†ìŒ'}</strong></div><div class="small">${e.date}</div>`;
        const right=document.createElement('button'); right.className='btn ghost'; right.textContent=(state.cursor===e.id?'ë‹«ê¸°':'ë³´ê¸°');
        right.onclick=()=>{ if(state.cursor===e.id){ resetComposer(); renderRecent(); } else { loadEntry(e.id); renderRecent(); } };
        it.append(left,right); box.appendChild(it);
      });
    }catch(e){ console.warn('renderRecent error', e); }
  }

  function renderCalendar(){
    try{
      const cal = $('#calendar'); if(!cal) return;
      cal.innerHTML='';
      const ym = $('#ym');
      const cur = new Date(state.cal.getFullYear(), state.cal.getMonth(), 1);
      if(ym) ym.textContent = `${cur.getFullYear()}ë…„ ${String(cur.getMonth()+1).padStart(2,'0')}ì›”`;

      const daysHeader = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
      daysHeader.forEach(d=>{ const h=document.createElement('div'); h.className='cell head'; h.textContent=d; cal.appendChild(h); });

      const firstDay = new Date(cur.getFullYear(), cur.getMonth(), 1).getDay();
      const lastDate = new Date(cur.getFullYear(), cur.getMonth()+1, 0).getDate();

      for(let i=0;i<firstDay;i++){ const e=document.createElement('div'); e.className='cell head'; e.style.visibility='hidden'; cal.appendChild(e); }

      const saved = new Set(state.entries.filter(e=>{
        if(!e.date) return false;
        const {y,m} = parseYMD(e.date);
        return y===cur.getFullYear() && m===cur.getMonth()+1;
      }).map(e=> parseYMD(e.date).d));

      const today=new Date();
      for(let d=1; d<=lastDate; d++){
        const cell=document.createElement('div'); cell.className='cell'; cell.textContent=String(d);
        if(saved.has(d)) cell.classList.add('saved');
        if(d===today.getDate() && cur.getMonth()===today.getMonth() && cur.getFullYear()===today.getFullYear()) cell.classList.add('today');
        cell.onclick=()=>{ state.cal = new Date(cur.getFullYear(), cur.getMonth(), d);
          const key = `${cur.getFullYear()}-${String(cur.getMonth()+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
          const hit = state.entries.find(e=>e.date===key); if(hit){ state.cursor=hit.id; } else { state.cursor=null; }
          reflectCurrent();
        };
        cal.appendChild(cell);
      }
    }catch(e){ console.warn('renderCalendar error', e); }
  }

  function reflectCurrent(){
    try{
      const img=$('#preview'); const ph=$('#previewWrap .ph'); const pw=$('#previewWrap');
      if(!state.cursor){
        if(img){ img.src=''; img.style.display='none'; } if(ph){ ph.style.display='grid'; } if(pw){ pw.classList.remove('has-image'); }
        $('#text').value=''; const ti=$('#title'); if(ti) ti.value=''; state.tempPhotos=[]; state.tempNames=[]; state.repIndex=0; state.viewIndex=0; renderGallery(); return;
      }
      const e = state.entries.find(x=>x.id===state.cursor); if(!e) return;
      state.tempPhotos = Array.isArray(e.photos)? e.photos.slice(0,MAX_UPLOAD) : (e.photo ? [e.photo] : []);
      state.tempNames = e.notes?.map(n=> n?.desc || '') || [];
      state.repIndex = e.repIndex || 0; state.viewIndex = state.repIndex;
      if(state.tempPhotos.length && img){
        img.onload=()=>{ img.style.display='block'; if(ph) ph.style.display='none'; if(pw) pw.classList.add('has-image'); };
        img.src = state.tempPhotos[state.repIndex];
      }else{
        if(img){ img.src=''; img.style.display='none'; } if(ph){ ph.style.display='grid'; } if(pw) pw.classList.remove('has-image');
      }
      $('#text').value = e.body || ''; const ti=$('#title'); if(ti) ti.value = e.title || '';
      renderGallery();
    }catch(e){ console.warn('reflectCurrent error', e); }
  }

  function loadEntry(id){
    state.cursor = id;
    reflectCurrent();
  }

  function renderGallery(){
    try{
      const cnt=$('#camCount'); const thumbs=$('#thumbs');
      if(!thumbs) return;
      if(cnt) cnt.textContent = String(state.tempPhotos.length);
      thumbs.innerHTML='';
      state.tempPhotos.forEach((src, i)=>{
        const t=document.createElement('div'); t.className='thumb';
        const im=document.createElement('img'); im.src=src;
        const x=document.createElement('div'); x.className='x'; x.textContent='Ã—';
        x.onclick=()=>{ state.tempPhotos.splice(i,1); if(state.tempNames) state.tempNames.splice(i,1); if(state.repIndex>=state.tempPhotos.length) state.repIndex=Math.max(0,state.tempPhotos.length-1); renderGallery(); updatePreviewFromView(); };
        const badge=document.createElement('div'); badge.className='badge'; badge.textContent = (i===state.repIndex)?'ëŒ€í‘œì‚¬ì§„':'ëŒ€í‘œë¡œ';
        badge.onclick=()=>{ state.repIndex=i; state.viewIndex=i; updatePreviewFromView(); renderGallery(); };
        t.append(im,x,badge);
        thumbs.appendChild(t);
      });
    }catch(e){ console.warn('renderGallery error', e); }
  }

  function updatePreviewFromView(){
    const img=$('#preview'); const ph=$('#previewWrap .ph'); const pw=$('#previewWrap');
    const rep = state.tempPhotos[state.viewIndex];
    if(rep && img){
      img.onload=()=>{ img.style.display='block'; if(ph) ph.style.display='none'; if(pw) pw.classList.add('has-image'); };
      img.src = rep;
    }else{
      if(img){ img.src=''; img.style.display='none'; } if(ph){ ph.style.display='grid'; } if(pw){ pw.classList.remove('has-image'); }
    }
  }

  function resetComposer(){
    state.cursor=null; state.tempPhotos=[]; state.tempNames=[]; state.repIndex=0; state.viewIndex=0;
    const img=$('#preview'); const ph=$('#previewWrap .ph'); const pw=$('#previewWrap');
    const ta=$('#text'); const ti=$('#title'); const fi=$('#file');
    if(fi) fi.value=''; if(img){ img.src=''; img.style.display='none'; } if(ph){ ph.style.display='grid'; } if(pw){ pw.classList.remove('has-image'); }
    if(ta) ta.value=''; if(ti) ti.value='';
    renderGallery();
  }

  function renderAll(){
    renderStats();
    renderRecent();
    renderCalendar();
    reflectCurrent();
  }

  // ================== ì´ˆê¸° ë°”ì¸ë”© ==================
  window.addEventListener('DOMContentLoaded', ()=>{
    // í…Œë§ˆ
    applyTheme(state.theme);
    const darkToggleApp = $('#darkToggleApp');
    if(darkToggleApp){
      darkToggleApp.checked = state.theme==='dark';
      darkToggleApp.addEventListener('change', ()=>{
        state.theme = darkToggleApp.checked?'dark':'light';
        applyTheme(state.theme);
      });
    }

    // ì¸íŠ¸ë¡œ â†’ ì•± ì „í™˜
    const intro = $('#intro');
    const app = $('#app');
    const startBtn = $('#startBtn');
    if(intro) intro.style.display='block';
    if(app) app.style.display='none';
    if(startBtn){
      startBtn.addEventListener('click', ()=>{
        try{
          resetComposer();
          if(intro) intro.style.display='none';
          if(app) app.style.display='block';
          renderAll();                 // í•µì‹¬: ì „í™˜ ì¦‰ì‹œ ë Œë”
        }catch(e){ console.warn('startBtn error', e); }
      });
    }

    // ì „í™˜ ì „ì—ë„ ë‹¬ë ¥ í•œë²ˆ ê·¸ë ¤ë‘ (ì•ˆì „ë§). ìˆ¨ê²¨ì ¸ ìˆì–´ë„ ìƒì„± ê°€ëŠ¥.
    try{ renderCalendar(); }catch(e){}

    // ë‹¬ë ¥ ì›” ì´ë™
    const prevM = $('#prevM'), nextM = $('#nextM');
    if(prevM) prevM.addEventListener('click', ()=>{ state.cal = new Date(state.cal.getFullYear(), state.cal.getMonth()-1, 1); renderCalendar(); });
    if(nextM) nextM.addEventListener('click', ()=>{ state.cal = new Date(state.cal.getFullYear(), state.cal.getMonth()+1, 1); renderCalendar(); });

    // ì¹´ë©”ë¼ íƒ€ì¼
    const cameraTile = $('#cameraTile'); if(cameraTile) cameraTile.addEventListener('click', ()=> $('#file').click());

    // íŒŒì¼ ì—…ë¡œë“œ
    const fileInput = $('#file');
    if(fileInput){
      fileInput.addEventListener('change', async (ev)=>{
        const files = Array.from(ev.target.files || []); if(!files.length) return;
        state.tempNames = state.tempNames || [];
        const remain = MAX_UPLOAD - state.tempPhotos.length; const pick = files.slice(0, remain);
        let loaded = 0;
        for(const f of pick){
          try{
            const durl = await downscaleToDataURL(f, 1280, 0.8);
            state.tempPhotos.push(durl);
            state.tempNames.push(f.name||'');
            loaded++;
            if(loaded===pick.length){
              state.repIndex = 0; state.viewIndex = 0;
              renderGallery(); updatePreviewFromView();
            }
          }catch(e){ console.warn('resize fail', e); }
        }
      });
    }

    // ìë™ìƒì„±
    const autoBtn = $('#autoBtn');
    if(autoBtn){
      autoBtn.addEventListener('click', async ()=>{
        if(!state.tempPhotos || state.tempPhotos.length===0){
          alert('ì§ì ‘ ì…ë ¥í•˜ì‹œê±°ë‚˜ ì‚¬ì§„ì„ ë„£ì–´ì£¼ì„¸ìš”');
          return;
        }
        const photosSummary = buildPhotosSummary(state);
        const tone = state.tone || 'ì¤‘ë¦½';
        const images = state.tempPhotos.slice(0,MAX_UPLOAD);

        const api = await callAutoDiaryAPI(images, photosSummary, tone);
        if(!api){ return; }
        const category = classifyCategory(state.tempNames||[]);
        const resultText = api.body || fallbackGenerate(photosSummary, category);
        const ta=$('#text'); if(ta) ta.value = resultText;
      });
    }

    // ì €ì¥
    const saveBtn = $('#saveBtn');
    if(saveBtn){
      saveBtn.addEventListener('click', ()=>{
        try{
          const body = ($('#text')?.value || '').trim();
          const ti=$('#title'); const title = (ti && ti.value ? ti.value : 'ì œëª© ì—†ìŒ').slice(0,20);
          if(!body){ alert('ì¼ê¸° ë‚´ìš©ì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.'); return; }
          const now = new Date();
          const entry = {
            id: state.cursor || newId(),
            title, body,
            photo: state.tempPhotos[state.repIndex] || '',
            photos: state.tempPhotos.slice(0,MAX_UPLOAD),
            repIndex: state.repIndex,
            notes: buildPhotosSummary(state),
            tone: state.tone || 'ì¤‘ë¦½',
            date: `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`,
            ts: now.getTime()
          };
          const idx = state.entries.findIndex(e=>e.id===entry.id);
          if(idx>=0) state.entries[idx]=entry; else state.entries.push(entry);
          state.cursor = entry.id;
          saveLS('entries', state.entries);
          renderRecent(); renderStats(); renderCalendar(); reflectCurrent();
        }catch(e){
          console.error(e);
          alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      });
    }

    // ì‚­ì œ
    const delBtn = $('#delBtn');
    if(delBtn){
      delBtn.addEventListener('click', ()=>{
        if(!state.cursor){ resetComposer(); return; }
        state.entries = state.entries.filter(e=>e.id!==state.cursor);
        saveLS('entries', state.entries);
        resetComposer(); renderAll();
      });
    }

    // ìºëŸ¬ì…€
    const prev = $('#navPrev'), next = $('#navNext');
    if(prev) prev.addEventListener('click', ()=>{ if(state.tempPhotos.length){ state.viewIndex = (state.viewIndex - 1 + state.tempPhotos.length) % state.tempPhotos.length; updatePreviewFromView(); } });
    if(next) next.addEventListener('click', ()=>{ if(state.tempPhotos.length){ state.viewIndex = (state.viewIndex + 1) % state.tempPhotos.length; updatePreviewFromView(); } });
  });
})();
</script>
 </body>
</html>
