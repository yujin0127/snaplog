<!DOCTYPE html>

<html data-theme="light" lang="ko">
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <title>
   ìŠ¤ëƒ…ë¡œê·¸ | Snaplog
  </title>
  <style>
   :root{
  --bg-grad-1:#f3e9ff; --bg-grad-2:#d9f7ff; --bg-grad-3:#ffeaf2;
  --panel:rgba(255,255,255,.85); --card:rgba(255,255,255,.70);
  --text:#171717; --muted:#585e6a;
  --line:rgba(0,0,0,.08); --line-strong:rgba(0,0,0,.12);
  --accent:#6d59ff; --accent-2:#ff7ab6; --accent-3:#6feaff;
  --chip:#fff7ff; --shadow: 0 10px 30px rgba(0,0,0,.12);
}
html[data-theme="dark"]{
  --bg-grad-1:#0c0f16; --bg-grad-2:#0b1320; --bg-grad-3:#151028;
  --panel:rgba(22,24,32,.92); --card:rgba(28,32,42,.92);
  --text:#f2f3f5; --muted:#bfc6d2;
  --line:rgba(255,255,255,.12); --line-strong:rgba(255,255,255,.18);
  --accent:#9ea4ff; --accent-2:#ff9ad1; --accent-3:#93eaff;
  --chip:#1f2430; --shadow: 0 12px 34px rgba(0,0,0,.55);
}
*{box-sizing:border-box}
body{margin:0; color:var(--text); font-family: ui-sans-serif, -apple-system, Segoe UI, Noto Sans KR, Pretendard, Roboto, system-ui, Arial, Apple SD Gothic Neo, sans-serif;}
.bg{ min-height:100svh; padding:24px; display:flex; align-items:center; justify-content:center;
  background: radial-gradient(70% 60% at 20% 10%, var(--bg-grad-1), transparent 70%),
              radial-gradient(80% 70% at 80% 0%, var(--bg-grad-2), transparent 70%),
              radial-gradient(80% 70% at 50% 100%, var(--bg-grad-3), transparent 70%),
              linear-gradient(135deg, var(--bg-grad-1), var(--bg-grad-2)); }
.panel{ width:min(1100px, 96vw); background:var(--panel); border:1px solid var(--line); backdrop-filter: blur(10px); box-shadow: var(--shadow); border-radius:24px; overflow:hidden; }
.topbar{ display:flex; gap:12px; align-items:center; padding:14px 18px; border-bottom:1px solid var(--line); }
.brand{ font-weight:900; font-size:20px; } .spacer{flex:1}
.btn{ appearance:none; border:none; cursor:pointer; font-weight:800; padding:12px 16px; border-radius:14px; box-shadow:0 3px 0 rgba(0,0,0,.2); color:#fff;
  background:linear-gradient(135deg, var(--accent), var(--accent-2)); display:inline-flex; align-items:center; justify-content:center; }
.btn.ghost{ background:transparent; color:var(--text); border:1px solid var(--line-strong); display:inline-flex; align-items:center; justify-content:center; height:49px; padding:0 10px; min-width:auto; white-space:nowrap; line-height:1; box-sizing:border-box; vertical-align:middle; }
.intro{ padding:28px 40px 40px; text-align:center; }
.intro .hero{ font-size:42px; font-weight:900; margin:8px 0 4px;
  background: linear-gradient(135deg, var(--accent), var(--accent-2), var(--accent-3));
  -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
.intro .sub{ color:var(--muted); font-size:14px; }
.cta{ margin-top:16px; display:flex; gap:10px; justify-content:center; }
.toggle{ display:inline-flex; align-items:center; gap:8px; }
.switch{ position:relative; width:56px; height:32px; } .switch input{opacity:0;width:0;height:0}
.switch .slider{ position:absolute; inset:0; background:#cfd3db; border:1px solid var(--line-strong); border-radius:32px; cursor:pointer; transition:.25s; }
html[data-theme="dark"] .switch .slider{ background:#2b3342; }
.switch .slider::before{ content:""; position:absolute; left:4px; bottom:4px; width:24px; height:24px; background:#fff; border-radius:50%; box-shadow:0 2px 6px rgba(0,0,0,.25); transition:.25s; }
.switch input:checked + .slider{ background:linear-gradient(135deg,var(--accent),var(--accent-2)); }
.switch input:checked + .slider::before{ transform: translateX(24px); }
.layout{ display:none; grid-template-columns: 300px 1fr; gap:16px; padding:16px; }
.card{ background:var(--card); border:1px solid var(--line); padding:14px; border-radius:16px; box-shadow: var(--shadow); overflow:hidden }
.section-title{ font-weight:900; margin-bottom:8px; display:flex; align-items:center; gap:8px; }
.calendar{ display:grid; grid-template-columns: repeat(7, minmax(0,1fr)); gap:8px; font-size:12px; width:100% }
.cell{ aspect-ratio:1/1; display:flex; align-items:center; justify-content:center; border-radius:10px; border:1px solid var(--line); background:#fff; color:#222; }
html[data-theme="dark"] .cell{ background:#1d2230; color:#e8ebf0; border-color:var(--line-strong); }
.cell.head{ aspect-ratio:auto; height:auto; padding:8px 0; background:transparent; border:none; color:var(--muted); font-weight:700; }
.cell.saved{ background:linear-gradient(135deg, var(--accent-3), var(--accent-2)); color:#121212; font-weight:900; border-color:transparent; }
.cell.today{ outline:2px dashed var(--accent); outline-offset:2px; }
.tools{ display:grid; grid-template-columns: repeat(2, 1fr); gap:12px; align-items:stretch; }
.input-file{ position:relative; overflow:hidden; display:inline-flex; align-items:center; justify-content:center; }
.input-file input{ position:absolute; inset:0; opacity:0; cursor:pointer; }
.badge{ font-size:12px; padding:6px 8px; background:var(--chip); border-radius:8px; border:1px solid var(--line); color:var(--text); }
.preview-wrap{ width:100%; border:1px dashed var(--line-strong); border-radius:12px; background:linear-gradient(135deg,#f7f8fb,#eef1f7); display:grid; place-items:center; position:relative; padding:8px; min-height:200px; box-sizing:border-box; overflow:hidden }
.preview-wrap .ph{ color:var(--muted); font-size:13px; }
.preview{ display:none; width:100%; height:auto; max-width:100%; max-height:70vh; object-fit:contain; border-radius:8px }
.preview-wrap.has-image{ border-style:solid; }
.editor{ display:grid; gap:10px; margin-top:10px; }
.titlebox{ height:44px; padding:10px 12px; border-radius:12px; border:1px solid var(--line-strong); background:#fff; color:#111; width:100%; }
html[data-theme="dark"] .titlebox{ background:#0f1420; color:#e8ebf0; }
.textbox{ min-height:120px; padding:10px; border-radius:12px; border:1px solid var(--line-strong); background:#fff; color:#111; }
html[data-theme="dark"] .textbox{ background:#0f1420; color:#e8ebf0; }
.tabs{ display:flex; gap:8px; margin-top:10px; }
.tab{ flex:1; text-align:center; padding:10px 12px; border-radius:12px; font-weight:800; background:linear-gradient(135deg, #fff, #f7f7ff); border:1px solid var(--line); cursor:pointer; color:#222; }
html[data-theme="dark"] .tab{ background:linear-gradient(135deg, #1b2030, #151a27); color:#e8ebf0; border-color:var(--line-strong); }
.tab.active{ outline:2px solid var(--accent); outline-offset:2px; }
.list{ display:grid; gap:8px; }
.item{ display:flex; gap:10px; align-items:center; justify-content:space-between; padding:12px; border-radius:12px; border:1px solid var(--line); background:var(--panel); }
.item img{ width:44px; height:44px; object-fit:cover; border-radius:10px; border:1px solid var(--line); background:#000; }
.item:hover{ transform: translateY(-1px); transition: .15s; }
.small{ font-size:12px; color:var(--muted); }
#recent{ max-height: 240px; overflow:auto; padding-right:4px; }
#recent::-webkit-scrollbar{ width:6px; } #recent::-webkit-scrollbar-thumb{ background:var(--line-strong); border-radius:6px; }
hr{ border:none; border-top:1px solid var(--line); }
.hidden{ display:none !important; }
@media (max-width: 900px){
  .panel{ width:96vw; border-radius:18px; } .topbar{ flex-wrap:wrap; gap:8px; }
  .intro .hero{ font-size: clamp(24px, 6vw, 32px); } .intro{ padding:24px; }
  .layout{ grid-template-columns: 1fr; padding:12px; }
  .preview-wrap{ width:100%; border:1px dashed var(--line-strong); border-radius:12px; background:linear-gradient(135deg,#f7f8fb,#eef1f7); display:grid; place-items:center; position:relative; padding:8px; min-height:200px; box-sizing:border-box; overflow:hidden } .tabs{ gap:6px; } .calendar{ gap:6px; } .cell{ font-size:11px; }
  #recent{ max-height:210px; }
}

.daily_button{ width:100%; height: 50px; font-size:18px; border-radius:18px; }
@media (max-width:640px){  .daily_button{ height:50px; font-size:17px;  .ghost{ width:90%; max-width:360px; } } }

/* gallery */
.gallery{ display:flex; gap:10px; align-items:center; overflow-x:auto; overflow-y:hidden; padding:8px 2px; margin-top:10px; max-width:100%; box-sizing:border-box; -webkit-overflow-scrolling:touch }
.gallery::-webkit-scrollbar{ height:6px; } .gallery::-webkit-scrollbar-thumb{ background:var(--line-strong); border-radius:6px; }
.camera-tile{ flex:0 0 auto; width:70px; height:70px; border:1px solid var(--line-strong); border-radius:14px; display:grid; place-items:center; color:#7a8190; background:#fff; }
html[data-theme="dark"] .camera-tile{ background:#0f1420; }
.cam-icon{ font-size:26px; line-height:1; }
.cam-count{ font-size:14px; margin-top:2px; color:#7a8190; }
.thumbs{ display:flex; gap:10px; align-items:center; }
.thumb{ position:relative; flex:0 0 auto; width:70px; height:70px; border-radius:14px; overflow:hidden; border:1px solid var(--line); }
.thumb img{ width:100%; height:100%; object-fit:cover; display:block; }
.thumb .x{ position:absolute; top:4px; right:4px; width:22px; height:22px; border-radius:50%; background:#0008; color:#fff; font-weight:900; display:grid; place-items:center; cursor:pointer; }
.thumb .badge{ position:absolute; left:4px; bottom:4px; background:#000c; color:#fff; font-size:11px; padding:2px 6px; border-radius:10px; }
.nav-arrow{ position:absolute; top:50%; transform:translateY(-50%); width:36px; height:36px; border-radius:50%; border:1px solid var(--line-strong); background:var(--card); color:var(--text); display:none; align-items:center; justify-content:center; font-size:20px; cursor:pointer; }
#navPrev{ left:8px; } #navNext{ right:8px; }
.preview-wrap.has-image .nav-arrow{ display:flex; }

html,body{overflow-x:hidden}
img,video{max-width:100%;height:auto}

/* Dark mode: saved day gradient same as light */
html[data-theme="dark"] .calendar .cell.saved{
  background: linear-gradient(135deg, var(--accent-3), var(--accent-2)) !important;
  color:#ffffff !important;
  border-color:transparent !important;
}

.camera-tile {
  display: flex !important;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 2px !important;
}
  </style>
 </head>
 <body>
  <div class="bg">
   <!-- Intro -->
   <div class="panel" id="intro">
    <div class="intro" style="display:flex; flex-direction:column; align-items:center; justify-content:center;">
     <div class="hero">
      ìŠ¤ëƒ…ë¡œê·¸
     </div>
     <div class="sub">
      ì‚¬ì§„ìœ¼ë¡œ ë‚¨ê¸°ëŠ” ì˜¤ëŠ˜ì˜ ìˆœê°„
     </div>
     <div class="cta">
      <button class="btn" id="startBtn">
       ì‹œì‘í•˜ê¸°
      </button>
     </div>
    </div>
   </div>
   <!-- App -->
   <div class="panel" id="app" style="display:none">
    <div class="topbar">
     <div class="brand">
      ìŠ¤ëƒ…ë¡œê·¸
     </div>
     <span class="badge" id="statAll">
      ì „ì²´ 0
     </span>
     <span class="badge" id="statMonth">
      ì´ë²ˆ ë‹¬ 0
     </span>
     <span class="badge" id="statPhotos">
      ì‚¬ì§„ 0
     </span>
     <div class="spacer">
     </div>
     <div class="toggle" title="ë‹¤í¬ëª¨ë“œ">
      <span aria-hidden="true" class="label">
       ë‹¤í¬ëª¨ë“œ
      </span>
      <label class="switch">
       <input id="darkToggleApp" type="checkbox"/>
       <span class="slider">
       </span>
      </label>
     </div>
    </div>
    <div class="layout" style="display:grid">
     <aside class="card">
      <div class="section-title">
       ë‹¬ë ¥
      </div>
      <div class="row small" style="margin-bottom:6px; display:flex; gap:6px; align-items:center;">
       <button class="btn ghost" id="prevM">
        â—€ï¸
       </button>
       <div id="ym">
       </div>
       <button class="btn ghost" id="nextM">
        â–¶ï¸
       </button>
      </div>
      <div class="calendar" id="calendar">
      </div>
      <hr style="opacity:.6; margin:12px 0"/>
      <div class="section-title">
       ìµœê·¼ ê¸°ë¡
      </div>
      <div class="list small" id="recent">
      </div>
     </aside>
     <section class="card">
      <div class="section-title">
       ì˜¤ëŠ˜ì˜ ê¸°ë¡
      </div>
      <div class="tools">
       <label class="btn input-file daily_button">
        ì‚¬ì§„ ì—…ë¡œë“œ
        <input accept="image/*" id="file" multiple="" type="file"/>
       </label>
       <button class="btn daily_button" id="autoBtn">
        ìë™ ìƒì„±
       </button>
       <button class="btn daily_button" id="saveBtn">
        ì €ì¥
       </button>
       <button class="btn ghost daily_button" id="delBtn">
        ì‚­ì œ
       </button>
      </div>
      <div style="margin-top:10px; position:relative">
       <div class="preview-wrap" id="previewWrap">
        <span class="ph">
         ë¯¸ë¦¬ë³´ê¸°
        </span>
        <img alt="ë¯¸ë¦¬ë³´ê¸°" class="preview" id="preview"/>
        <button class="nav-arrow" id="navPrev">
         â€¹
        </button>
        <button class="nav-arrow" id="navNext">
         â€º
        </button>
       </div>
       <div class="gallery" id="galleryBar">
        <div class="camera-tile" id="cameraTile">
         <div class="cam-icon">
          ğŸ“·
         </div>
         <div class="cam-count">
          <span id="camCount">
           0
          </span>
          /10
         </div>
        </div>
        <div class="thumbs" id="thumbs">
        </div>
       </div>
      </div>
      <div class="editor">
       <input class="titlebox" id="title" maxlength="20" placeholder="ì œëª©(ìµœëŒ€ 20ì)" type="text"/>
      </div>
      <div class="editor">
       <textarea class="textbox" id="text" placeholder="ìë™ìœ¼ë¡œ ìƒì„±ë˜ê±°ë‚˜ ì§ì ‘ ì ì„ ìˆ˜ ìˆìŒ"></textarea>
      </div>
      <div class="tabs">
       <div class="tab active">
        ì¼ê¸°
       </div>
       <div class="tab">
        ì§€ë„
       </div>
       <div class="tab">
        ì „ì²´ì¼ê¸°
       </div>
      </div>
     </section>
    </div>
   </div>
  </div>
<script>
(function(){
  "use strict";

  // ================== ì„¤ì • ==================
  const API_URL = "http://127.0.0.1:5000/api/auto-diary";
  const FOOD_HINTS = ['food','meal','lunch','dinner','breakfast','cafe','coffee','cake','bread','noodle','ramen','pizza','burger','pasta','sushi','ì‹ë‹¹','ë°¥','ì ì‹¬','ì €ë…','ì•„ì¹¨','ì¹´í˜','ì»¤í”¼','ì¼€ì´í¬','ë¹µ','ë¼ë©´','í”¼ì','ë²„ê±°','íŒŒìŠ¤íƒ€','ìŠ¤ì‹œ'];
  const MAX_UPLOAD = 10;

  // ================== ìœ í‹¸ ==================
  const $ = (s,p=document)=>p.querySelector(s);
  const $$ = (s,p=document)=>Array.from(p.querySelectorAll(s));
  function saveLS(k,v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch(e){ console.warn("save fail",k,e); } }
  function loadLS(k,f){ try{ const v=localStorage.getItem(k); return v? JSON.parse(v): f; }catch(e){ return f; } }
  function newId(){ return Math.random().toString(36).slice(2)+Date.now().toString(36); }
  function getMonthKey(d){ return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,'0'); }
  function parseYMD(s){ const [y,m,d] = (s||"").split("-").map(x=>parseInt(x,10)); return {y,m,d}; }

  // ì´ë¯¸ì§€ ì¶•ì†Œ(JPEG) â†’ dataURL
  async function downscaleToDataURL(file, maxSide=1280, quality=0.8){
    const img = await new Promise((res,rej)=>{
      const fr = new FileReader();
      fr.onload = ()=>{ const i = new Image(); i.onload=()=>res(i); i.onerror=rej; i.src = fr.result; };
      fr.onerror = rej; fr.readAsDataURL(file);
    });
    const w = img.naturalWidth, h = img.naturalHeight;
    const ratio = w > h ? maxSide / w : maxSide / h;
    const nw = ratio < 1 ? Math.round(w*ratio) : w;
    const nh = ratio < 1 ? Math.round(h*ratio) : h;
    const canvas = document.createElement('canvas');
    canvas.width = nw; canvas.height = nh;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(img, 0, 0, nw, nh);
    return canvas.toDataURL('image/jpeg', quality);
  }

  // ================== ìƒíƒœ ==================
  const state = {
    entries: loadLS('entries', []),
    theme: loadLS('theme','light'),
    cursor:null,
    cal:new Date(),
    tempPhotos:[],
    tempNames:[],
    repIndex:0,
    viewIndex:0,
    tone:'ì¤‘ë¦½'
  };

  // ================== ë¶„ë¥˜/ë¼ë²¨ ==================
  function classifyCategory(fileNames){
    if(!fileNames || !fileNames.length) return 'general_single';
    if(fileNames.length === 1){
      const n = (fileNames[0]||'').toLowerCase();
      const isFood = FOOD_HINTS.some(k=> n.includes(k));
      return isFood ? 'food_single' : 'general_single';
    }
    return 'journey_multi';
  }

  function normalizeTimeLabel(idx, total){
    if(total<=1) return 'ì˜¤í›„';
    const ratio = idx/(total-1);
    if(ratio < 0.25) return 'ì˜¤ì „';
    if(ratio < 0.5) return 'ì •ì˜¤';
    if(ratio < 0.75) return 'ì˜¤í›„';
    return 'ì €ë…';
  }

  // ================== Summary (íŒŒì¼ëª…/â€œë¯¸ìƒâ€ ì œê±°) ==================
  function buildPhotosSummary(state){
    const total = state.tempPhotos.length;
    const now = new Date();
    const ymd = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
    const arr = [];
    for(let i=0;i<total;i++){
      arr.push({
        place: '',                                 // ë¹„ì›Œë‘ 
        time: `${ymd} ${normalizeTimeLabel(i,total)}`,
        weather: '',                               // ë¹„ì›Œë‘ 
        desc: ''                                   // íŒŒì¼ëª… ìœ ë˜ í…ìŠ¤íŠ¸ ê¸ˆì§€
      });
    }
    return arr;
  }

  // ================== Vision API í˜¸ì¶œ ==================
  async function callAutoDiaryAPI(images, photosSummary, tone){
    if(!API_URL) return null;
    const ctrl = new AbortController();
    const t = setTimeout(()=>ctrl.abort('timeout'), 45000); // 45s
    try{
      const r = await fetch(API_URL, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ tone, images, photosSummary }),
        signal: ctrl.signal
      });
      clearTimeout(t);
      const text = await r.text();
      let data = null;
      try{ data = JSON.parse(text); }catch{}
      if(!r.ok){
        const msg = data?.error || data?.message || (`HTTP ${r.status}: `+text.slice(0,200));
        alert('ìë™ìƒì„± ì‹¤íŒ¨: '+msg);
        return null;
      }
      if(data && data.ok) return data;
      alert('ìë™ìƒì„± ì‹¤íŒ¨: '+(data?.error || 'unknown'));
      return null;
    }catch(e){
      clearTimeout(t);
      alert('ìë™ìƒì„± ì„œë²„ ì‘ë‹µì´ ì—†ìŠµë‹ˆë‹¤: '+e);
      return null;
    }
  }

  // ================== Fallback ë¬¸ì¥ ìì—°í™” ==================
  function fallbackGenerate(photosSummary, cat){
    const n = photosSummary.length;
    const s = x => x || '';

    if(cat === 'journey_multi' && n>=2){
      const a = photosSummary;
      const t0 = s(a[0].time).split(' ').pop();
      const first = s(a[0].place) ? `${s(a[0].place)}ì—ì„œ ${t0}ì— í•˜ë£¨ë¥¼ ì—´ì—ˆë‹¤.` : `${t0}ì— í•˜ë£¨ë¥¼ ì—´ì—ˆë‹¤.`;
      const parts = [first];
      for(let i=1;i<n-1;i++){
        const seg = [];
        if (s(a[i].place)) seg.push(`${s(a[i].place)}ë¡œ ì˜®ê¸°ë©°`);
        if (s(a[i].desc))  seg.push(`${s(a[i].desc)}ì„ ì§€ë‚˜ì³¤ë‹¤`);
        parts.push(seg.length ? seg.join(' ') + '.' : 'ì ì‹œ ê±¸ìŒì„ ëŠ¦ì·„ë‹¤.');
      }
      parts.push(`${s(a[n-1].place) || 'ì£¼ë³€'}ì˜ ë¹›ì´ ì²œì²œíˆ ë°”ë€Œì—ˆë‹¤.`);
      parts.push('ë‚¨ì€ ì†Œë¦¬ì™€ ì˜¨ê¸°ê°€ ì¡°ìš©íˆ ì •ë¦¬ë˜ì—ˆë‹¤.');
      return parts.slice(0,7).join("\n");
    } else {
      const p = photosSummary[0] || {place:'', time:'ì˜¤í›„', weather:'', desc:''};
      const tpart = s(p.time).split(' ').pop();
      const first = s(p.place) ? `${s(p.place)}ì—ì„œ ${tpart}ì— ì ì‹œ ë©ˆì·„ë‹¤.` : `${tpart}ì— ì ì‹œ ë©ˆì·„ë‹¤.`;
      const parts = [first];
      if (s(p.desc)) parts.push(`${s(p.desc)}ì´ ëˆˆì— ë“¤ì–´ì™”ë‹¤.`);
      parts.push('ìˆ¨ì„ ê³ ë¥´ë‹ˆ ê³µê°„ì˜ ê²°ì´ ë˜ë ·í•´ì¡Œë‹¤.');
      parts.push('ì§§ì€ ê³ ìš”ê°€ ì˜¤ëŠ˜ì˜ ëì„ ë¶€ë“œëŸ½ê²Œ ë®ì—ˆë‹¤.');
      return parts.slice(0,4).join("\n");
    }
  }

  // ================== í…Œë§ˆ ==================
  function applyTheme(t){ document.documentElement.setAttribute('data-theme', t); saveLS('theme', t); }

  // ================== ë Œë”ëŸ¬ ==================
  function renderStats(){
    const all = state.entries.length;
    const monthKey = getMonthKey(new Date());
    const month = state.entries.filter(e=> (e.date||"").startsWith(monthKey)).length;
    const photos = state.entries.filter(e=> Array.isArray(e.photos) ? e.photos.length : (e.photo?1:0)).length;
    $('#statAll').textContent = `ì „ì²´ ${all}`;
    $('#statMonth').textContent = `ì´ë²ˆ ë‹¬ ${month}`;
    $('#statPhotos').textContent = `ì‚¬ì§„ ${photos}`;
  }

  function renderRecent(){
    const box = $('#recent'); if(!box) return;
    box.innerHTML='';
    state.entries.slice().reverse().slice(0,50).forEach(e=>{
      const it=document.createElement('div'); it.className='item';
      const left=document.createElement('div');
      left.innerHTML = `<div><strong>${e.title || 'ì œëª© ì—†ìŒ'}</strong></div><div class="small">${e.date}</div>`;
      const right=document.createElement('button'); right.className='btn ghost'; right.textContent=(state.cursor===e.id?'ë‹«ê¸°':'ë³´ê¸°');
      right.onclick=()=>{ if(state.cursor===e.id){ resetComposer(); renderRecent(); } else { loadEntry(e.id); renderRecent(); } };
      it.append(left,right); box.appendChild(it);
    });
  }

  function renderCalendar(){
    const cal = $('#calendar'); if(!cal) return;
    cal.innerHTML='';
    const ym = $('#ym');
    const cur = new Date(state.cal.getFullYear(), state.cal.getMonth(), 1);
    if(ym) ym.textContent = `${cur.getFullYear()}ë…„ ${String(cur.getMonth()+1).padStart(2,'0')}ì›”`;

    const daysHeader = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
    daysHeader.forEach(d=>{ const h=document.createElement('div'); h.className='cell head'; h.textContent=d; cal.appendChild(h); });

    const firstDay = new Date(cur.getFullYear(), cur.getMonth(), 1).getDay();
    const lastDate = new Date(cur.getFullYear(), cur.getMonth()+1, 0).getDate();

    for(let i=0;i<firstDay;i++){ const e=document.createElement('div'); e.className='cell head'; e.style.visibility='hidden'; cal.appendChild(e); }

    const saved = new Set(state.entries.filter(e=>{
      if(!e.date) return false;
      const {y,m} = parseYMD(e.date);
      return y===cur.getFullYear() && m===cur.getMonth()+1;
    }).map(e=> parseYMD(e.date).d));

    const today=new Date();
    for(let d=1; d<=lastDate; d++){
      const cell=document.createElement('div'); cell.className='cell'; cell.textContent=String(d);
      if(saved.has(d)) cell.classList.add('saved');
      if(d===today.getDate() && cur.getMonth()===today.getMonth() && cur.getFullYear()===today.getFullYear()) cell.classList.add('today');
      cell.onclick=()=>{ state.cal = new Date(cur.getFullYear(), cur.getMonth(), d);
        const key = `${cur.getFullYear()}-${String(cur.getMonth()+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const hit = state.entries.find(e=>e.date===key); if(hit){ state.cursor=hit.id; } else { state.cursor=null; }
        reflectCurrent();
      };
      cal.appendChild(cell);
    }
  }

  function reflectCurrent(){
    const img=$('#preview'); const ph=$('#previewWrap .ph'); const pw=$('#previewWrap');
    if(!state.cursor){
      if(img){ img.src=''; img.style.display='none'; } if(ph){ ph.style.display='grid'; } if(pw){ pw.classList.remove('has-image'); }
      $('#text').value=''; const ti=$('#title'); if(ti) ti.value=''; state.tempPhotos=[]; state.tempNames=[]; state.repIndex=0; state.viewIndex=0; renderGallery(); return;
    }
    const e = state.entries.find(x=>x.id===state.cursor); if(!e) return;
    state.tempPhotos = Array.isArray(e.photos)? e.photos.slice(0,MAX_UPLOAD) : (e.photo ? [e.photo] : []);
    state.tempNames = e.notes?.map(n=> n?.desc || '') || [];
    state.repIndex = e.repIndex || 0; state.viewIndex = state.repIndex;
    if(state.tempPhotos.length && img){
      img.onload=()=>{ img.style.display='block'; if(ph) ph.style.display='none'; if(pw) pw.classList.add('has-image'); };
      img.src = state.tempPhotos[state.repIndex];
    }else{
      if(img){ img.src=''; img.style.display='none'; } if(ph){ ph.style.display='grid'; } if(pw){ pw.classList.remove('has-image'); }
    }
    $('#text').value = e.body || ''; const ti=$('#title'); if(ti) ti.value = e.title || '';
    renderGallery();
  }

  function loadEntry(id){
    state.cursor = id;
    reflectCurrent();
  }

  function renderGallery(){
    const cnt=$('#camCount'); const thumbs=$('#thumbs');
    if(!thumbs) return;
    if(cnt) cnt.textContent = String(state.tempPhotos.length);
    thumbs.innerHTML='';
    state.tempPhotos.forEach((src, i)=>{
      const t=document.createElement('div'); t.className='thumb';
      const im=document.createElement('img'); im.src=src;
      const x=document.createElement('div'); x.className='x'; x.textContent='Ã—';
      x.onclick=()=>{ state.tempPhotos.splice(i,1); if(state.tempNames) state.tempNames.splice(i,1); if(state.repIndex>=state.tempPhotos.length) state.repIndex=Math.max(0,state.tempPhotos.length-1); renderGallery(); updatePreviewFromView(); };
      const badge=document.createElement('div'); badge.className='badge'; badge.textContent = (i===state.repIndex)?'ëŒ€í‘œì‚¬ì§„':'ëŒ€í‘œë¡œ';
      badge.onclick=()=>{ state.repIndex=i; state.viewIndex=i; updatePreviewFromView(); renderGallery(); };
      t.append(im,x,badge);
      thumbs.appendChild(t);
    });
  }

  function updatePreviewFromView(){
    const img=$('#preview'); const ph=$('#previewWrap .ph'); const pw=$('#previewWrap');
    const rep = state.tempPhotos[state.viewIndex];
    if(rep && img){
      img.onload=()=>{ img.style.display='block'; if(ph) ph.style.display='none'; if(pw) pw.classList.add('has-image'); };
      img.src = rep;
    }else{
      if(img){ img.src=''; img.style.display='none'; } if(ph){ ph.style.display='grid'; } if(pw){ pw.classList.remove('has-image'); }
    }
  }

  function resetComposer(){
    state.cursor=null; state.tempPhotos=[]; state.tempNames=[]; state.repIndex=0; state.viewIndex=0;
    const img=$('#preview'); const ph=$('#previewWrap .ph'); const pw=$('#previewWrap');
    const ta=$('#text'); const ti=$('#title'); const fi=$('#file');
    if(fi) fi.value=''; if(img){ img.src=''; img.style.display='none'; } if(ph){ ph.style.display='grid'; } if(pw){ pw.classList.remove('has-image'); }
    if(ta) ta.value=''; if(ti) ti.value='';
    renderGallery();
  }

  function renderAll(){ renderStats(); renderRecent(); renderCalendar(); reflectCurrent(); }

  // ================== ì´ˆê¸° ë°”ì¸ë”©(ì¸íŠ¸ë¡œ í¬í•¨) ==================
  window.addEventListener('load', ()=>{
    // í…Œë§ˆ
    applyTheme(state.theme);
    const darkToggleApp = $('#darkToggleApp');
    if(darkToggleApp){
      darkToggleApp.checked = state.theme==='dark';
      darkToggleApp.addEventListener('change', ()=>{
        state.theme = darkToggleApp.checked?'dark':'light';
        applyTheme(state.theme);
      });
    }

    // ì¸íŠ¸ë¡œ â†’ ì•± ì „í™˜
    const intro = $('#intro');
    const app = $('#app');
    if(intro && app){
      intro.style.display='block';
      app.style.display='none';
      const startBtn = $('#startBtn');
      if(startBtn){
        startBtn.addEventListener('click', ()=>{
          resetComposer();
          intro.style.display='none';
          app.style.display='block';
          renderAll();
        });
      }
    }

    // ë‹¬ë ¥ ì›” ì´ë™
    const prevM = $('#prevM'), nextM = $('#nextM');
    if(prevM) prevM.addEventListener('click', ()=>{ state.cal = new Date(state.cal.getFullYear(), state.cal.getMonth()-1, 1); renderCalendar(); });
    if(nextM) nextM.addEventListener('click', ()=>{ state.cal = new Date(state.cal.getFullYear(), state.cal.getMonth()+1, 1); renderCalendar(); });

    // ì¹´ë©”ë¼ íƒ€ì¼
    const cameraTile = $('#cameraTile'); if(cameraTile) cameraTile.addEventListener('click', ()=> $('#file').click());

    // íŒŒì¼ ì—…ë¡œë“œ(ì—¬ëŸ¬ ì¥, ì¶•ì†Œ ì €ì¥)
    const fileInput = $('#file');
    if(fileInput){
      fileInput.addEventListener('change', async (ev)=>{
        const files = Array.from(ev.target.files || []); if(!files.length) return;
        state.tempNames = state.tempNames || [];
        const remain = MAX_UPLOAD - state.tempPhotos.length; const pick = files.slice(0, remain);
        let loaded = 0;
        for(const f of pick){
          try{
            const durl = await downscaleToDataURL(f, 1280, 0.8);
            state.tempPhotos.push(durl);
            state.tempNames.push(f.name||'');
            loaded++;
            if(loaded===pick.length){
              state.repIndex = 0; state.viewIndex = 0;
              renderGallery(); updatePreviewFromView();
            }
          }catch(e){
            console.warn('resize fail', e);
          }
        }
      });
    }

    // ìë™ìƒì„±
    const autoBtn = $('#autoBtn');
    if(autoBtn){
      autoBtn.addEventListener('click', async ()=>{
        if(!state.tempPhotos || state.tempPhotos.length===0){
          alert('ì§ì ‘ ì…ë ¥í•˜ì‹œê±°ë‚˜ ì‚¬ì§„ì„ ë„£ì–´ì£¼ì„¸ìš”');
          return;
        }
        const photosSummary = buildPhotosSummary(state);
        const tone = state.tone || 'ì¤‘ë¦½';
        const images = state.tempPhotos.slice(0,MAX_UPLOAD);
        console.log('send images:', images.length);

        const api = await callAutoDiaryAPI(images, photosSummary, tone);
        if(!api){ return; } // alertëŠ” callAutoDiaryAPI ë‚´ì—ì„œ ì²˜ë¦¬
        console.log('auto-diary used:', api.used);

        const category = classifyCategory(state.tempNames||[]);
        const resultText = api.body || fallbackGenerate(photosSummary, category);
        const ta=$('#text'); if(ta) ta.value = resultText;
      });
    }

    // ì €ì¥
    const saveBtn = $('#saveBtn');
    if(saveBtn){
      saveBtn.addEventListener('click', ()=>{
        try{
          const body = ($('#text')?.value || '').trim();
          const ti=$('#title'); const title = (ti && ti.value ? ti.value : 'ì œëª© ì—†ìŒ').slice(0,20);
          if(!body){ alert('ì¼ê¸° ë‚´ìš©ì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.'); return; }
          const now = new Date();
          const entry = {
            id: state.cursor || newId(),
            title, body,
            photo: state.tempPhotos[state.repIndex] || '',
            photos: state.tempPhotos.slice(0,MAX_UPLOAD),
            repIndex: state.repIndex,
            notes: buildPhotosSummary(state),
            tone: state.tone || 'ì¤‘ë¦½',
            date: `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`,
            ts: now.getTime()
          };
          const idx = state.entries.findIndex(e=>e.id===entry.id);
          if(idx>=0) state.entries[idx]=entry; else state.entries.push(entry);
          state.cursor = entry.id;
          saveLS('entries', state.entries);
          renderRecent(); renderStats(); renderCalendar(); reflectCurrent();
        }catch(e){
          console.error(e);
          alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      });
    }

    // ì‚­ì œ
    const delBtn = $('#delBtn');
    if(delBtn){
      delBtn.addEventListener('click', ()=>{
        if(!state.cursor){ resetComposer(); return; }
        state.entries = state.entries.filter(e=>e.id!==state.cursor);
        saveLS('entries', state.entries);
        resetComposer(); renderAll();
      });
    }

    // ìºëŸ¬ì…€
    const prev = $('#navPrev'), next = $('#navNext');
    if(prev) prev.addEventListener('click', ()=>{ if(state.tempPhotos.length){ state.viewIndex = (state.viewIndex - 1 + state.tempPhotos.length) % state.tempPhotos.length; updatePreviewFromView(); } });
    if(next) next.addEventListener('click', ()=>{ if(state.tempPhotos.length){ state.viewIndex = (state.viewIndex + 1) % state.tempPhotos.length; updatePreviewFromView(); } });
  });
})();
</script>
 </body>
</html>
